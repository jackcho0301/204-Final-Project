<!DOCTYPE html>
<html lang="en">

<head>
    <title>Movie Search</title>
    <link href="tmdb.css" type="text/css" rel="stylesheet">
</head>

<body>

    <div id="hidden-div">
        <button class="btn" id="close_button">CLOSE</button>
        <button class="btn" id="prev_button">&lt;</button>
        <button class="btn" id="next_button">&gt;</button>
        <br>
        <iframe id="trailer">
        </iframe>
        <h3 id="detail-title"></h3>
        <p id="detail-overview"></p>
    </div>

    <div id="form_container">
        <form id="form">
            <label for="input">Search Movie:</label>
            <!-- <input type="text" class="form-control" id="first-name" value="Michael" required> -->
            <input type="text" id="input">
            <button type="submit" id="search-btn">Add</button>
        </form>
    </div>

    <button type="submit" id="popular-btn">See Popular</button>
    <button type="submit" id="latest-btn">See Top-Rated</button>

    <h2 id="heading">See Popular</h2>

    <div id="container">

    </div>

    <div id="attribution-container">
        Attribution:
        <img id="attribution" src="tmdb_logo.png" alt="TMDB ATTRIBUTION" />
    </div>


    <!-- ++++++++++++++++++++++++++++++++++++++ -->

    <script>

        //my key:
        //0c1cfc186512612b10c8d9f9fe03adb2

        //search eg:
        //https://api.themoviedb.org/3/search/movie?api_key=0c1cfc186512612b10c8d9f9fe03adb2&query=Cloverfield

        //cloverfield video:
        // https://www.youtube.com/watch?v=
        // 8brYvhEg5Aw

        //for video:
        //use this request:
        //https://api.themoviedb.org/3/movie/{movie_id}/videos?api_key=<<api_key>>&language=en-US
        //movie id 384521
        //api key: 0c1cfc186512612b10c8d9f9fe03adb2
        //ex: 
        // https://api.themoviedb.org/3/movie/384521/videos?api_key=0c1cfc186512612b10c8d9f9fe03adb2&language=en-US
        //and then get the key
        //and append key to:
        //https://www.youtube.com/watch?v=


        //finding movie by id:
        //https://api.themoviedb.org/3/movie/7191?api_key=0c1cfc186512612b10c8d9f9fe03adb2&language=en-US



        const form = document.getElementById("form");
        form.addEventListener("submit", search, false);

        const popularButton = document.getElementById("popular-btn");
        popularButton.addEventListener("click", seePopular, false);

        const latestButton = document.getElementById("latest-btn");
        latestButton.addEventListener("click", seeTopRated, false);

        var heading = document.getElementById("heading");

        var trailer = document.getElementById("trailer");

        var trailerKey = " ";

        var movieId = " ";

        var movieTitle = "";

        var detailTitle = document.getElementById("detail-title");
        var detailOverview = document.getElementById("detail-overview");
        

        var hiddenDiv = document.getElementById("hidden-div");

        var closeButton = document.getElementById("close_button");

        var allPosters = document.getElementsByClassName("posters");
        closeButton.addEventListener("click", closeHiddenDiv);

        var posterContainer = document.getElementById("container");


        var movieObject = {};
        


        function closeHiddenDiv () {
            hiddenDiv.style.zIndex = -1;
            trailer.setAttribute("src", "");
            for (var i = 0; i < allPosters.length; i++) {
                allPosters[i].style.opacity = 1;
            }
        }



        //see popular upon load:
        seePopular();

        function clicked(event) {
            hiddenDiv.style.zIndex = 1;

            console.log("clicked");
            // poster.style.border = "5px solid blue";
            event.target.style.border = "5px solid blue";
            // trailer.setAttribute("src", "https://www.youtube.com/embed" + )
            console.log(event.target.id);

            for (var i = 0; i < allPosters.length; i++) {
                allPosters[i].style.opacity = 0.5;
            }
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    var videoRequest = JSON.parse(this.responseText);
                    // console.log(videoRequest.results[0].key);
                    if(videoRequest.results.length > 0){
                    trailer.setAttribute("src", "https://www.youtube.com/embed/" + videoRequest.results[0].key);
                }
                else{
                    //trailer not found
                }
                }
                else if (this.readyState == 4) {

                    // this.status !== 200, error from server
                    console.log(this.responseText);

                };
               
            }
            xhttp.open("GET", "https://api.themoviedb.org/3/movie/" + event.target.id + "/videos?api_key=0c1cfc186512612b10c8d9f9fe03adb2&language=en-US", true);
                xhttp.send();
//
                var xhttp2 = new XMLHttpRequest();
            xhttp2.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    var movieById = JSON.parse(this.responseText);
                    console.log("overview: " + movieById.overview);
                    console.log("release date: " + movieById.release_date);
                    console.log("runtime: " + movieById.runtime);

                    detailTitle.innerHTML = movieById.original_title;
                    detailOverview.innerHTML = movieById.overview;
                    
                
                }
                else if (this.readyState == 4) {

                    // this.status !== 200, error from server
                    console.log(this.responseText);

                };
               
            }
            xhttp2.open("GET", "https://api.themoviedb.org/3/movie/" + event.target.id + "?api_key=0c1cfc186512612b10c8d9f9fe03adb2&language=en-US", true);
                xhttp2.send();

                // https://api.themoviedb.org/3/movie/7191?api_key=0c1cfc186512612b10c8d9f9fe03adb2&language=en-US

                

        }

        function borderAppear(event) {
            event.target.style.border = "5px solid red";
        }

        function borderDisappear(event) {
            event.target.style.border = "5px solid white";
        }



        //search movies:
        function search(event) {
            event.preventDefault();
            var input = document.getElementById("input");
            var inputValue = input.value;

            heading.innerHTML = "Search Result:";

            posterContainer.innerHTML = "";

            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    var results = JSON.parse(this.responseText);
                    for (var i = 0; i < results.results.length; i++) {

                        if (results.results[i].poster_path != null) {
                            var poster = document.createElement("img");
                            poster.setAttribute("src", "https://image.tmdb.org/t/p/original" + results.results[i].poster_path);
                            poster.setAttribute("class", "posters");
                            poster.setAttribute("id", results.results[i].id);
                            posterContainer.appendChild(poster);
                        }
                        if (results.results[i].poster_path == null) {
                            var poster = document.createElement("img");
                            poster.setAttribute("src", "poster_null.png");
                            poster.setAttribute("class", "posters");
                            poster.setAttribute("id", results.results[i].id);
                            posterContainer.appendChild(poster);
                        }
                    }
                    for (var i = 0; i < allPosters.length; i++) {
                        allPosters[i].style.border = "5px solid white";
                        allPosters[i].addEventListener("click", clicked);
                        allPosters[i].addEventListener("mouseover", borderAppear);
                        allPosters[i].addEventListener("mouseout", borderDisappear);
                    }


                }
            };
            xhttp.open("GET", "https://api.themoviedb.org/3/search/movie?api_key=0c1cfc186512612b10c8d9f9fe03adb2&query=" + inputValue, true);
            xhttp.send();
        }

        //see popular movies:
        function seePopular() {
            heading.innerHTML = "Popular Movies:";

            posterContainer.innerHTML = "";
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    var results = JSON.parse(this.responseText);

                    for (var i = 0; i < results.results.length; i++) {
                        if (results.results[i].poster_path != null) {
                            var poster = document.createElement("img");
                            poster.setAttribute("src", "https://image.tmdb.org/t/p/original" + results.results[i].poster_path);
                            poster.setAttribute("class", "posters");
                            poster.setAttribute("id", results.results[i].id);
                            posterContainer.appendChild(poster);
                        }
                        if (results.results[i].poster_path == null) {
                            var poster = document.createElement("img");
                            poster.setAttribute("src", "poster_null.png");
                            poster.setAttribute("class", "posters");
                            poster.setAttribute("id", results.results[i].id);
                            posterContainer.appendChild(poster);
                        }
                    }
                    
                    for (var i = 0; i < allPosters.length; i++) {
                        allPosters[i].style.border = "5px solid white";
                        allPosters[i].addEventListener("click", clicked);
                        allPosters[i].addEventListener("mouseover", borderAppear);
                        allPosters[i].addEventListener("mouseout", borderDisappear);
                    }
                }
            };
            xhttp.open("GET", "https://api.themoviedb.org/3/movie/popular?api_key=0c1cfc186512612b10c8d9f9fe03adb2&language=en-US&page=1", true);
            xhttp.send();
        }

        //see top rated movies:
        function seeTopRated() {
            heading.innerHTML = "Top-Rated Movies:";

            posterContainer.innerHTML = "";
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    var results = JSON.parse(this.responseText);

                    for (var i = 0; i < results.results.length; i++) {
                        if (results.results[i].poster_path != null) {
                            var poster = document.createElement("img");
                            poster.setAttribute("src", "https://image.tmdb.org/t/p/original" + results.results[i].poster_path);
                            poster.setAttribute("class", "posters");
                            poster.setAttribute("id", results.results[i].id);

                            posterContainer.appendChild(poster);
                        }
                        if (results.results[i].poster_path == null) {
                            var poster = document.createElement("img");
                            poster.setAttribute("src", "poster_null.png");
                            poster.setAttribute("class", "posters");
                            poster.setAttribute("id", results.results[i].id);
                            posterContainer.appendChild(poster);
                        }
                    }
                    for (var i = 0; i < allPosters.length; i++) {
                        allPosters[i].style.border = "5px solid white";
                        allPosters[i].addEventListener("click", clicked);
                        allPosters[i].addEventListener("mouseover", borderAppear);
                        allPosters[i].addEventListener("mouseout", borderDisappear);
                    }
                }
            };
            xhttp.open("GET", "https://api.themoviedb.org/3/movie/top_rated?api_key=0c1cfc186512612b10c8d9f9fe03adb2&language=en-US&page=1", true);
            xhttp.send();
        }


    </script>

</body>

</html>